<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifying Access - HR Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .loading-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 3rem;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        .spinner {
            font-size: 2rem;
            color: #667eea;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .access-denied {
            display: none;
        }
        .access-denied-icon {
            font-size: 4rem;
            color: #dc3545;
            margin-bottom: 1rem;
        }
        .btn-home {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: white;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
            transition: transform 0.2s;
        }
        .btn-home:hover {
            transform: translateY(-2px);
            color: white;
        }
        .btn-login {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: white;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
            transition: transform 0.2s;
        }
        .btn-login:hover {
            transform: translateY(-2px);
            color: white;
        }
    </style>
</head>
<body>
    <div class="loading-card">
        <div id="loadingSection">
            <i class="fas fa-circle-notch spinner"></i>
            <h3 class="mt-3">Verifying Access</h3>
            <p class="text-muted">Please wait while we check your permissions...</p>
        </div>
        
        <div id="accessDeniedSection" class="access-denied">
            <i class="fas fa-shield-alt access-denied-icon"></i>
            <h1 class="h2 mb-3">Superadmin Access Required</h1>
            <p class="text-muted mb-4" id="deniedMessage">
                This page requires superadmin privileges to access.
            </p>
            <div class="d-flex flex-column flex-sm-row justify-content-center">
                <a href="/login" class="btn-home">
                    <i class="fas fa-sign-in-alt"></i> Go to Login
                </a>
                <a href="/login" class="btn-login">
                    <i class="fas fa-sign-in-alt"></i> Login as Superadmin
                </a>
            </div>
        </div>
    </div>

    <script>
        async function checkSuperadminAccess() {
            try {
                const token = localStorage.getItem('access_token');
                const employee = JSON.parse(localStorage.getItem('employee') || '{}');
                
                if (!token || !employee.email) {
                    showAccessDenied('Please log in with superadmin credentials.');
                    return;
                }
                
                // Check if user is superadmin
                if (employee.role === 'super_admin' || employee.email.toLowerCase().includes('superadmin')) {
                    // User is superadmin, verify with server and load appropriate content
                    const response = await fetch('/api/auth/me', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.employee.role === 'super_admin' || data.employee.email.toLowerCase().includes('superadmin')) {
                            loadTargetPage();
                            return;
                        }
                    }
                }
                
                showAccessDenied('Your account does not have superadmin privileges.');
                
            } catch (error) {
                showAccessDenied('Authentication error. Please log in again.');
            }
        }
        
        function showAccessDenied(message) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('accessDeniedSection').style.display = 'block';
            document.getElementById('deniedMessage').textContent = message;
        }
        
        function loadTargetPage() {
            // Load the appropriate page content
            {% if debug_login_page %}
                loadDebugLoginPage();
            {% elif rbac_guide_page %}
                loadRbacGuidePage();
            {% else %}
                window.location.href = '/';
            {% endif %}
        }
        
        function loadDebugLoginPage() {
            document.body.innerHTML = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Debug Login - HR Management System</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
                    <style>
                        body {
                            background: #f8f9fa;
                            padding: 20px;
                        }
                        .debug-container {
                            max-width: 800px;
                            margin: 0 auto;
                            background: white;
                            border-radius: 10px;
                            padding: 30px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        }
                        .credential-card {
                            background: #f8f9fa;
                            padding: 20px;
                            border-radius: 8px;
                            margin: 10px 0;
                            border-left: 4px solid #007bff;
                        }
                        .btn-test {
                            margin: 5px;
                        }
                    </style>
                </head>
                <body>
                    <div class="debug-container">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1><i class="fas fa-bug text-primary"></i> Debug Login Panel</h1>
                            <a href="/" class="btn btn-outline-secondary">
                                <i class="fas fa-home"></i> Home
                            </a>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Superadmin Only:</strong> This debug panel is only accessible to superadmin users.
                        </div>
                        
                        <h3>Available Test Credentials:</h3>
                        
                        <div class="credential-card">
                            <h5><strong>Organization Admin (Acme Corp)</strong></h5>
                            <p><strong>Email:</strong> <code>admin@acme-corp.com</code></p>
                            <p><strong>Password:</strong> <code>admin123</code></p>
                            <p><strong>Role:</strong> admin</p>
                            <button class="btn btn-primary btn-test" onclick="testLogin('admin@acme-corp.com', 'admin123')">
                                <i class="fas fa-sign-in-alt"></i> Test Login
                            </button>
                        </div>
                        
                        <div class="credential-card">
                            <h5><strong>Manager (Acme Corp)</strong></h5>
                            <p><strong>Email:</strong> <code>jane.doe@acme-corp.com</code></p>
                            <p><strong>Password:</strong> <code>admin123</code></p>
                            <p><strong>Role:</strong> manager</p>
                            <button class="btn btn-success btn-test" onclick="testLogin('jane.doe@acme-corp.com', 'admin123')">
                                <i class="fas fa-sign-in-alt"></i> Test Login
                            </button>
                        </div>
                        
                        <div class="credential-card">
                            <h5><strong>Employee (Acme Corp)</strong></h5>
                            <p><strong>Email:</strong> <code>john.smith@acme-corp.com</code></p>
                            <p><strong>Password:</strong> <code>employee123</code></p>
                            <p><strong>Role:</strong> employee</p>
                            <button class="btn btn-info btn-test" onclick="testLogin('john.smith@acme-corp.com', 'employee123')">
                                <i class="fas fa-sign-in-alt"></i> Test Login
                            </button>
                        </div>
                        
                        <div class="mt-4">
                            <h4>Authentication Status:</h4>
                            <div id="authStatus" class="alert alert-info">
                                <div id="currentUser"></div>
                                <button class="btn btn-outline-danger btn-sm mt-2" onclick="clearAuth()">
                                    <i class="fas fa-sign-out-alt"></i> Clear Authentication
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <script>
                        async function testLogin(email, password) {
                            try {
                                const response = await fetch('/api/auth/login', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ email, password })
                                });
                                
                                const data = await response.json();
                                
                                if (response.ok) {
                                    localStorage.setItem('access_token', data.access_token);
                                    localStorage.setItem('refresh_token', data.refresh_token);
                                    localStorage.setItem('employee', JSON.stringify(data.employee));
                                    localStorage.setItem('organization', JSON.stringify(data.organization));
                                    
                                    updateAuthStatus();
                                    alert('Login successful! You can now test the application with this user.');
                                } else {
                                    alert('Login failed: ' + data.error);
                                }
                            } catch (error) {
                                alert('Error: ' + error.message);
                            }
                        }
                        
                        function clearAuth() {
                            localStorage.removeItem('access_token');
                            localStorage.removeItem('refresh_token');
                            localStorage.removeItem('employee');
                            localStorage.removeItem('organization');
                            updateAuthStatus();
                        }
                        
                        function updateAuthStatus() {
                            const employee = JSON.parse(localStorage.getItem('employee') || '{}');
                            const authDiv = document.getElementById('currentUser');
                            
                            if (employee.first_name) {
                                authDiv.innerHTML = 
                                    '<strong>Currently logged in as:</strong><br>' +
                                    employee.first_name + ' ' + employee.last_name + ' (' + employee.role + ')<br>' +
                                    '<small>Email: ' + employee.email + '</small>';
                            } else {
                                authDiv.innerHTML = '<em>No active session</em>';
                            }
                        }
                        
                        // Initialize auth status
                        updateAuthStatus();
                    </script>
                </body>
                </html>
            `;
        }
        
        function loadRbacGuidePage() {
            // Redirect to load the actual RBAC guide content
            fetch('/templates/rbac_guide.html')
                .then(response => response.text())
                .then(html => {
                    document.open();
                    document.write(html);
                    document.close();
                })
                .catch(() => {
                    window.location.href = '/';
                });
        }
        
        // Start the access check
        checkSuperadminAccess();
    </script>
</body>
</html>