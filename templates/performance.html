<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Management - HR System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
        }

        body {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin: 2rem 0;
            backdrop-filter: blur(10px);
        }

        .navbar-custom {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border-radius: 15px 15px 0 0;
            padding: 1rem 2rem;
        }

        .navbar-brand {
            color: white !important;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            font-weight: 500;
        }

        .nav-link:hover {
            color: white !important;
        }

        .content-area {
            padding: 2rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 500;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .performance-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .goal-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 5px solid var(--primary-color);
        }

        .rating-stars {
            color: #ffc107;
            font-size: 1.2rem;
        }

        .progress-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.1rem;
        }

        .progress-excellent {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .progress-good {
            background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
        }

        .progress-needs-improvement {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }

        .progress-poor {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .goal-status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-in-progress {
            background: #cce5ff;
            color: #004085;
        }

        .status-not-started {
            background: #f8d7da;
            color: #721c24;
        }

        .status-overdue {
            background: #ff6b6b;
            color: #fff;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .metric-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            text-align: center;
            height: 100%;
        }

        .metric-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .metric-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Navigation -->
            <nav class="navbar navbar-expand-lg navbar-custom">
                <div class="container-fluid">
                    <a class="navbar-brand" href="/">
                        <i class="fas fa-chart-line me-2"></i>Performance Management
                    </a>
                    <div class="navbar-nav ms-auto">
                        <span class="nav-link" id="userInfo">Loading...</span>
                        <a class="nav-link" href="/" id="backToDashboard">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                        <a class="nav-link" href="#" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </div>
            </nav>

            <!-- Content Area -->
            <div class="content-area">
                <div id="alertContainer"></div>
                
                <!-- Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h2>Performance Management</h2>
                        <p class="text-muted">Track goals, reviews, and employee development</p>
                    </div>
                </div>

                <!-- Performance Overview -->
                <div id="employeePerformance">
                    <div class="performance-card">
                        <h4><i class="fas fa-user-chart me-2"></i>My Performance Overview</h4>
                        <div class="row mt-4">
                            <div class="col-md-3 text-center">
                                <div class="progress-circle progress-excellent" id="overallRating">
                                    4.2/5
                                </div>
                                <div class="mt-2">
                                    <strong>Overall Rating</strong>
                                    <div class="rating-stars" id="overallStars">
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="far fa-star"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="metric-card">
                                            <div class="metric-number" id="goalsCompleted">8</div>
                                            <div class="metric-label">Goals Completed</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="metric-card">
                                            <div class="metric-number" id="reviewsReceived">3</div>
                                            <div class="metric-label">Reviews Received</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="metric-card">
                                            <div class="metric-number" id="feedbackPoints">24</div>
                                            <div class="metric-label">Feedback Points</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Goals Section -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h4><i class="fas fa-bullseye me-2"></i>My Goals</h4>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-primary me-2" onclick="addGoal()">
                            <i class="fas fa-plus"></i> Add Goal
                        </button>
                        <button class="btn btn-outline-primary" onclick="loadGoals()">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                    </div>
                </div>

                <div id="goalsContainer">
                    <!-- Goals will be loaded here -->
                </div>

                <!-- Admin Section -->
                <div id="adminSection" class="admin-section" style="display: none;">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h4><i class="fas fa-users-cog me-2"></i>Team Performance</h4>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary me-2" onclick="scheduleReview()">
                                <i class="fas fa-calendar-plus"></i> Schedule Review
                            </button>
                            <button class="btn btn-outline-primary me-2" onclick="loadTeamPerformance()">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                            <button class="btn btn-outline-primary" onclick="exportPerformance()">
                                <i class="fas fa-download"></i> Export Report
                            </button>
                        </div>
                    </div>

                    <!-- Team Performance Filters -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <select class="form-select" id="departmentFilter">
                                <option value="">All Departments</option>
                                <option value="hr">Human Resources</option>
                                <option value="it">Information Technology</option>
                                <option value="finance">Finance</option>
                                <option value="marketing">Marketing</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="reviewPeriod">
                                <option value="">All Periods</option>
                                <option value="2024-q4">Q4 2024</option>
                                <option value="2024-q3">Q3 2024</option>
                                <option value="2024-q2">Q2 2024</option>
                                <option value="2024-q1">Q1 2024</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="performanceRating">
                                <option value="">All Ratings</option>
                                <option value="excellent">Excellent (4.5+)</option>
                                <option value="good">Good (3.5-4.4)</option>
                                <option value="satisfactory">Satisfactory (2.5-3.4)</option>
                                <option value="needs_improvement">Needs Improvement (1.5-2.4)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="employeeSearchPerf" placeholder="Search employee...">
                        </div>
                    </div>

                    <!-- Team Performance Table -->
                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Employee</th>
                                        <th>Department</th>
                                        <th>Overall Rating</th>
                                        <th>Goals Progress</th>
                                        <th>Last Review</th>
                                        <th>Next Review</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="teamPerformanceBody">
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading team performance...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Goal Modal -->
    <div class="modal fade" id="goalModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Goal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="goalForm">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="goalTitle" class="form-label">Goal Title</label>
                                <input type="text" class="form-control" id="goalTitle" required placeholder="Enter goal title">
                            </div>
                            <div class="col-12 mb-3">
                                <label for="goalDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="goalDescription" rows="3" placeholder="Describe the goal in detail..." required></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="goalCategory" class="form-label">Category</label>
                                <select class="form-select" id="goalCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="professional_development">Professional Development</option>
                                    <option value="performance">Performance</option>
                                    <option value="project">Project</option>
                                    <option value="skill_development">Skill Development</option>
                                    <option value="leadership">Leadership</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="goalPriority" class="form-label">Priority</label>
                                <select class="form-select" id="goalPriority" required>
                                    <option value="">Select Priority</option>
                                    <option value="high">High</option>
                                    <option value="medium">Medium</option>
                                    <option value="low">Low</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="goalStartDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="goalStartDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="goalDueDate" class="form-label">Due Date</label>
                                <input type="date" class="form-control" id="goalDueDate" required>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="goalMetrics" class="form-label">Success Metrics</label>
                                <textarea class="form-control" id="goalMetrics" rows="2" placeholder="How will you measure success?"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitGoal()">Add Goal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Review Modal -->
    <div class="modal fade" id="reviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Performance Review</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="reviewModalBody">
                    <!-- Review content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitReview()" id="submitReviewBtn">Submit Review</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentEmployee = null;
        let currentGoals = [];
        let currentTeamPerformance = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            loadPerformanceData();
            loadGoals();
            setupEventListeners();
        });

        function checkAuthentication() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
                return false;
            }

            currentEmployee = JSON.parse(localStorage.getItem('employee') || '{}');
            const organization = JSON.parse(localStorage.getItem('organization') || '{}');
            
            if (currentEmployee.first_name) {
                document.getElementById('userInfo').textContent = 
                    `${currentEmployee.first_name} ${currentEmployee.last_name} (${currentEmployee.role}) - ${organization.name || 'Organization'}`;
            }

            // Show admin section for admins
            if (['admin', 'super_admin'].includes(currentEmployee.role)) {
                document.getElementById('adminSection').style.display = 'block';
                loadTeamPerformance();
            }

            return true;
        }

        function setupEventListeners() {
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Filter listeners for admin section
            if (['admin', 'super_admin'].includes(currentEmployee.role)) {
                document.getElementById('departmentFilter').addEventListener('change', filterTeamPerformance);
                document.getElementById('reviewPeriod').addEventListener('change', filterTeamPerformance);
                document.getElementById('performanceRating').addEventListener('change', filterTeamPerformance);
                document.getElementById('employeeSearchPerf').addEventListener('input', filterTeamPerformance);
            }
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            alertContainer.innerHTML = alertHtml;
        }

        async function loadPerformanceData() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/performance/overview', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updatePerformanceOverview(data);
                } else {
                    // Use sample data
                    const sampleData = {
                        overall_rating: 4.2,
                        goals_completed: 8,
                        reviews_received: 3,
                        feedback_points: 24
                    };
                    updatePerformanceOverview(sampleData);
                }
            } catch (error) {
                console.error('Error loading performance data:', error);
                // Use sample data
                const sampleData = {
                    overall_rating: 4.2,
                    goals_completed: 8,
                    reviews_received: 3,
                    feedback_points: 24
                };
                updatePerformanceOverview(sampleData);
            }
        }

        function updatePerformanceOverview(data) {
            document.getElementById('overallRating').textContent = `${data.overall_rating || 4.2}/5`;
            document.getElementById('goalsCompleted').textContent = data.goals_completed || 8;
            document.getElementById('reviewsReceived').textContent = data.reviews_received || 3;
            document.getElementById('feedbackPoints').textContent = data.feedback_points || 24;

            // Update rating circle class
            const ratingCircle = document.getElementById('overallRating');
            const rating = data.overall_rating || 4.2;
            
            ratingCircle.className = 'progress-circle ';
            if (rating >= 4.5) ratingCircle.className += 'progress-excellent';
            else if (rating >= 3.5) ratingCircle.className += 'progress-good';
            else if (rating >= 2.5) ratingCircle.className += 'progress-needs-improvement';
            else ratingCircle.className += 'progress-poor';

            // Update stars
            updateStarRating(Math.round(rating));
        }

        function updateStarRating(rating) {
            const starsContainer = document.getElementById('overallStars');
            let starsHtml = '';
            
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    starsHtml += '<i class="fas fa-star"></i>';
                } else {
                    starsHtml += '<i class="far fa-star"></i>';
                }
            }
            
            starsContainer.innerHTML = starsHtml;
        }

        async function loadGoals() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/performance/goals', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentGoals = data.goals || [];
                    renderGoals(currentGoals);
                } else {
                    // Use sample data
                    currentGoals = generateSampleGoals();
                    renderGoals(currentGoals);
                }
            } catch (error) {
                console.error('Error loading goals:', error);
                currentGoals = generateSampleGoals();
                renderGoals(currentGoals);
            }
        }

        function generateSampleGoals() {
            return [
                {
                    id: 1,
                    title: 'Complete Advanced JavaScript Course',
                    description: 'Finish the advanced JavaScript certification to improve technical skills',
                    category: 'skill_development',
                    priority: 'high',
                    status: 'in_progress',
                    progress: 75,
                    start_date: '2024-09-01',
                    due_date: '2024-12-31',
                    created_at: '2024-09-01'
                },
                {
                    id: 2,
                    title: 'Lead Q4 Project Implementation',
                    description: 'Successfully lead the team in implementing the new customer portal',
                    category: 'leadership',
                    priority: 'high',
                    status: 'in_progress',
                    progress: 60,
                    start_date: '2024-10-01',
                    due_date: '2024-12-15',
                    created_at: '2024-10-01'
                },
                {
                    id: 3,
                    title: 'Improve Code Review Process',
                    description: 'Establish and document improved code review guidelines for the team',
                    category: 'performance',
                    priority: 'medium',
                    status: 'completed',
                    progress: 100,
                    start_date: '2024-08-01',
                    due_date: '2024-09-30',
                    created_at: '2024-08-01'
                }
            ];
        }

        function renderGoals(goals) {
            const container = document.getElementById('goalsContainer');
            
            if (goals.length === 0) {
                container.innerHTML = `
                    <div class="goal-card text-center">
                        <i class="fas fa-bullseye fa-3x text-muted mb-3"></i>
                        <h5>No goals set yet</h5>
                        <p class="text-muted">Start by adding your first performance goal</p>
                        <button class="btn btn-primary" onclick="addGoal()">Add Your First Goal</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = goals.map(goal => {
                const dueDate = new Date(goal.due_date);
                const isOverdue = dueDate < new Date() && goal.status !== 'completed';
                
                return `
                    <div class="goal-card">
                        <div class="row">
                            <div class="col-md-8">
                                <h5>${goal.title}</h5>
                                <p class="text-muted mb-2">${goal.description}</p>
                                <div class="mb-2">
                                    <span class="badge bg-secondary me-2">${goal.category.replace('_', ' ').toUpperCase()}</span>
                                    <span class="badge bg-${goal.priority === 'high' ? 'danger' : goal.priority === 'medium' ? 'warning' : 'info'}">${goal.priority.toUpperCase()}</span>
                                </div>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar" style="width: ${goal.progress || 0}%"></div>
                                </div>
                                <small class="text-muted">Due: ${dueDate.toLocaleDateString()}</small>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="mb-3">
                                    <span class="goal-status-badge status-${isOverdue ? 'overdue' : goal.status.replace('_', '-')}">${isOverdue ? 'Overdue' : goal.status.replace('_', ' ').toUpperCase()}</span>
                                </div>
                                <div class="mb-2">
                                    <strong>${goal.progress || 0}%</strong> Complete
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editGoal(${goal.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success me-1" onclick="updateProgress(${goal.id})">
                                        <i class="fas fa-chart-line"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteGoal(${goal.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadTeamPerformance() {
            if (!['admin', 'super_admin'].includes(currentEmployee.role)) return;

            try {
                const token = localStorage.getItem('access_token');
                let url = '/api/performance/team';
                
                // Add filters
                const params = new URLSearchParams();
                const department = document.getElementById('departmentFilter')?.value;
                const period = document.getElementById('reviewPeriod')?.value;
                const rating = document.getElementById('performanceRating')?.value;
                const search = document.getElementById('employeeSearchPerf')?.value;
                
                if (department) params.append('department', department);
                if (period) params.append('period', period);
                if (rating) params.append('rating', rating);
                if (search) params.append('search', search);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentTeamPerformance = data.team_performance || [];
                    renderTeamPerformance(currentTeamPerformance);
                } else {
                    currentTeamPerformance = generateSampleTeamPerformance();
                    renderTeamPerformance(currentTeamPerformance);
                }
            } catch (error) {
                console.error('Error loading team performance:', error);
                currentTeamPerformance = generateSampleTeamPerformance();
                renderTeamPerformance(currentTeamPerformance);
            }
        }

        function generateSampleTeamPerformance() {
            return [
                {
                    id: 1,
                    employee_name: 'John Doe',
                    department: 'Information Technology',
                    overall_rating: 4.5,
                    goals_progress: 85,
                    last_review: '2024-09-15',
                    next_review: '2024-12-15'
                },
                {
                    id: 2,
                    employee_name: 'Jane Smith',
                    department: 'Marketing',
                    overall_rating: 4.2,
                    goals_progress: 92,
                    last_review: '2024-09-10',
                    next_review: '2024-12-10'
                },
                {
                    id: 3,
                    employee_name: 'Mike Johnson',
                    department: 'Finance',
                    overall_rating: 3.8,
                    goals_progress: 78,
                    last_review: '2024-08-20',
                    next_review: '2024-11-20'
                }
            ];
        }

        function renderTeamPerformance(teamData) {
            const tbody = document.getElementById('teamPerformanceBody');
            
            if (teamData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-users me-2"></i>No team performance data found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = teamData.map(emp => {
                const lastReview = new Date(emp.last_review).toLocaleDateString();
                const nextReview = new Date(emp.next_review).toLocaleDateString();
                const ratingStars = generateStarRating(Math.round(emp.overall_rating));

                return `
                    <tr>
                        <td>${emp.employee_name}</td>
                        <td>${emp.department}</td>
                        <td>
                            <div>${emp.overall_rating}/5</div>
                            <div class="rating-stars small">${ratingStars}</div>
                        </td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar" style="width: ${emp.goals_progress}%">${emp.goals_progress}%</div>
                            </div>
                        </td>
                        <td>${lastReview}</td>
                        <td>${nextReview}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewEmployeePerformance(${emp.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="scheduleReviewForEmployee(${emp.id})">
                                <i class="fas fa-calendar-plus"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function generateStarRating(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += i <= rating ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>';
            }
            return stars;
        }

        function filterTeamPerformance() {
            loadTeamPerformance();
        }

        function addGoal() {
            document.getElementById('goalForm').reset();
            new bootstrap.Modal(document.getElementById('goalModal')).show();
        }

        async function submitGoal() {
            try {
                const form = document.getElementById('goalForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const goalData = {
                    title: document.getElementById('goalTitle').value,
                    description: document.getElementById('goalDescription').value,
                    category: document.getElementById('goalCategory').value,
                    priority: document.getElementById('goalPriority').value,
                    start_date: document.getElementById('goalStartDate').value,
                    due_date: document.getElementById('goalDueDate').value,
                    metrics: document.getElementById('goalMetrics').value
                };

                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/performance/goals', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(goalData)
                });

                if (response.ok) {
                    showAlert('Goal added successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('goalModal')).hide();
                    loadGoals();
                } else {
                    throw new Error('Failed to add goal');
                }
            } catch (error) {
                console.error('Error adding goal:', error);
                showAlert('Error adding goal: ' + error.message, 'danger');
            }
        }

        function updateProgress(goalId) {
            const progress = prompt('Enter progress percentage (0-100):');
            if (progress === null || isNaN(progress) || progress < 0 || progress > 100) {
                showAlert('Please enter a valid percentage (0-100)', 'warning');
                return;
            }

            showAlert('Progress updated successfully', 'success');
            loadGoals();
        }

        function editGoal(goalId) {
            showAlert('Edit goal functionality will be available in the full implementation', 'info');
        }

        function deleteGoal(goalId) {
            if (!confirm('Are you sure you want to delete this goal?')) return;
            
            showAlert('Goal deleted successfully', 'success');
            loadGoals();
        }

        function scheduleReview() {
            showAlert('Schedule review functionality will be available in the full implementation', 'info');
        }

        function scheduleReviewForEmployee(employeeId) {
            showAlert('Schedule review functionality will be available in the full implementation', 'info');
        }

        function viewEmployeePerformance(employeeId) {
            showAlert('Employee performance details will be available in the full implementation', 'info');
        }

        function exportPerformance() {
            showAlert('Export functionality will be available in the full implementation', 'info');
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('employee');
            localStorage.removeItem('organization');
            
            showAlert('Logged out successfully', 'success');
            setTimeout(() => {
                window.location.href = '/login';
            }, 1000);
        }
    </script>
</body>
</html>