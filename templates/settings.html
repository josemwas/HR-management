<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Settings - HR System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
        }

        body {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin: 2rem 0;
            backdrop-filter: blur(10px);
        }

        .navbar-custom {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border-radius: 15px 15px 0 0;
            padding: 1rem 2rem;
        }

        .navbar-brand {
            color: white !important;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            font-weight: 500;
        }

        .nav-link:hover {
            color: white !important;
        }

        .content-area {
            padding: 2rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 500;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .settings-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .setting-group {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .setting-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-color);
        }

        .setting-item:last-child {
            margin-bottom: 0;
        }

        .setting-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .setting-description {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .sensitive-indicator {
            color: #dc3545;
            font-size: 0.75rem;
        }

        .category-header {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
            font-weight: bold;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .preview-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            border: 2px dashed #dee2e6;
            text-align: center;
        }

        .color-preview {
            width: 50px;
            height: 30px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Navigation -->
            <nav class="navbar navbar-expand-lg navbar-custom">
                <div class="container-fluid">
                    <a class="navbar-brand" href="/">
                        <i class="fas fa-cogs me-2"></i>Organization Settings
                    </a>
                    <div class="navbar-nav ms-auto">
                        <span class="nav-link" id="userInfo">Loading...</span>
                        <a class="nav-link" href="/" id="backToDashboard">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                        <a class="nav-link" href="#" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </div>
            </nav>

            <!-- Content Area -->
            <div class="content-area">
                <div id="alertContainer"></div>
                
                <!-- Header -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h2>Organization Settings</h2>
                        <p class="text-muted">Configure your organization's preferences and policies</p>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-primary" onclick="saveAllSettings()">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button class="btn btn-outline-primary ms-2" onclick="loadSettings()">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- General Settings -->
                <div class="settings-card">
                    <h4 class="category-header">
                        <i class="fas fa-building me-2"></i>General Settings
                    </h4>
                    
                    <div class="setting-item">
                        <div class="setting-label">Organization Name</div>
                        <div class="setting-description">The official name of your organization</div>
                        <input type="text" class="form-control" id="organizationName" data-key="organization_name" data-category="general">
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">Primary Brand Color</div>
                        <div class="setting-description">Main color used throughout the application</div>
                        <div class="d-flex align-items-center">
                            <input type="color" class="form-control form-control-color" id="primaryColor" data-key="primary_color" data-category="general">
                            <div class="color-preview" id="colorPreview"></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="setting-item">
                                <div class="setting-label">Timezone</div>
                                <div class="setting-description">Default timezone for the organization</div>
                                <select class="form-select" id="timezone" data-key="timezone" data-category="general">
                                    <option value="UTC">UTC</option>
                                    <option value="America/New_York">Eastern Time</option>
                                    <option value="America/Chicago">Central Time</option>
                                    <option value="America/Denver">Mountain Time</option>
                                    <option value="America/Los_Angeles">Pacific Time</option>
                                    <option value="Europe/London">London</option>
                                    <option value="Europe/Paris">Paris</option>
                                    <option value="Asia/Tokyo">Tokyo</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="setting-item">
                                <div class="setting-label">Date Format</div>
                                <div class="setting-description">How dates are displayed</div>
                                <select class="form-select" id="dateFormat" data-key="date_format" data-category="general">
                                    <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                    <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                    <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                    <option value="DD-MM-YYYY">DD-MM-YYYY</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">Currency</div>
                        <div class="setting-description">Default currency for financial calculations</div>
                        <select class="form-select" id="currency" data-key="currency" data-category="general">
                            <option value="USD">USD - US Dollar</option>
                            <option value="EUR">EUR - Euro</option>
                            <option value="GBP">GBP - British Pound</option>
                            <option value="JPY">JPY - Japanese Yen</option>
                            <option value="CAD">CAD - Canadian Dollar</option>
                            <option value="AUD">AUD - Australian Dollar</option>
                            <option value="KES">Ksh. - Kenyan Shilling</option>
                        </select>
                    </div>
                </div>

                <!-- Attendance Settings -->
                <div class="settings-card">
                    <h4 class="category-header">
                        <i class="fas fa-clock me-2"></i>Attendance Settings
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="setting-item">
                                <div class="setting-label">Standard Work Hours</div>
                                <div class="setting-description">Number of hours considered a full work day</div>
                                <input type="number" class="form-control" id="standardWorkHours" data-key="standard_work_hours" data-category="attendance" min="1" max="24" step="0.5">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="setting-item">
                                <div class="setting-label">Grace Period (minutes)</div>
                                <div class="setting-description">Late arrival tolerance before marking as late</div>
                                <input type="number" class="form-control" id="gracePeriod" data-key="grace_period_minutes" data-category="attendance" min="0" max="60">
                            </div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">Require GPS Check-in</div>
                        <div class="setting-description">Employees must be at designated locations to check in</div>
                        <label class="switch">
                            <input type="checkbox" id="requireGPS" data-key="require_gps_checkin" data-category="attendance">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">Auto Checkout</div>
                        <div class="setting-description">Automatically check out employees after standard work hours</div>
                        <label class="switch">
                            <input type="checkbox" id="autoCheckout" data-key="auto_checkout" data-category="attendance">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Leave Settings -->
                <div class="settings-card">
                    <h4 class="category-header">
                        <i class="fas fa-calendar-alt me-2"></i>Leave Settings
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="setting-item">
                                <div class="setting-label">Annual Leave Days</div>
                                <div class="setting-description">Default annual leave allocation</div>
                                <input type="number" class="form-control" id="annualLeaveDays" data-key="annual_leave_days" data-category="leaves" min="0" max="365">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="setting-item">
                                <div class="setting-label">Sick Leave Days</div>
                                <div class="setting-description">Default sick leave allocation</div>
                                <input type="number" class="form-control" id="sickLeaveDays" data-key="sick_leave_days" data-category="leaves" min="0" max="365">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="setting-item">
                                <div class="setting-label">Personal Leave Days</div>
                                <div class="setting-description">Default personal leave allocation</div>
                                <input type="number" class="form-control" id="personalLeaveDays" data-key="personal_leave_days" data-category="leaves" min="0" max="365">
                            </div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">Require Manager Approval</div>
                        <div class="setting-description">All leave requests must be approved by a manager</div>
                        <label class="switch">
                            <input type="checkbox" id="requireApproval" data-key="require_manager_approval" data-category="leaves">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">Advance Notice Required (days)</div>
                        <div class="setting-description">Minimum days in advance for leave requests</div>
                        <input type="number" class="form-control" id="advanceNotice" data-key="advance_notice_days" data-category="leaves" min="0" max="30">
                    </div>
                </div>

                <!-- Security Settings -->
                <div class="settings-card">
                    <h4 class="category-header">
                        <i class="fas fa-shield-alt me-2"></i>Security Settings
                    </h4>
                    
                    <div class="setting-item">
                        <div class="setting-label">Enable Two-Factor Authentication</div>
                        <div class="setting-description">Require 2FA for all user accounts</div>
                        <label class="switch">
                            <input type="checkbox" id="enableTwoFactor" data-key="enable_two_factor" data-category="security">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">Session Timeout (minutes)</div>
                        <div class="setting-description">Automatically log out users after inactivity</div>
                        <input type="number" class="form-control" id="sessionTimeout" data-key="session_timeout_minutes" data-category="security" min="5" max="1440">
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">Password Policy</div>
                        <div class="setting-description">Configure password requirements</div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Minimum Length</label>
                                <input type="number" class="form-control" id="passwordMinLength" min="4" max="50" value="8">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Requirements</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="requireUppercase">
                                    <label class="form-check-label" for="requireUppercase">Uppercase letters</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="requireNumbers">
                                    <label class="form-check-label" for="requireNumbers">Numbers</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="requireSpecialChars">
                                    <label class="form-check-label" for="requireSpecialChars">Special characters</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notification Settings -->
                <div class="settings-card">
                    <h4 class="category-header">
                        <i class="fas fa-bell me-2"></i>Notification Settings
                    </h4>
                    
                    <div class="setting-item">
                        <div class="setting-label">Email Notifications</div>
                        <div class="setting-description">Send email notifications for important events</div>
                        <label class="switch">
                            <input type="checkbox" id="emailNotifications" data-key="email_notifications" data-category="notifications">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">SMS Notifications</div>
                        <div class="setting-description">Send SMS notifications for urgent events</div>
                        <label class="switch">
                            <input type="checkbox" id="smsNotifications" data-key="sms_notifications" data-category="notifications">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-label">Notification Email</div>
                        <div class="setting-description">Email address for system notifications <span class="sensitive-indicator">(Sensitive)</span></div>
                        <input type="email" class="form-control" id="notificationEmail" data-key="notification_email" data-category="notifications" data-sensitive="true">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentEmployee = null;
        let originalSettings = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            loadSettings();
            setupEventListeners();
        });

        function checkAuthentication() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
                return false;
            }

            currentEmployee = JSON.parse(localStorage.getItem('employee') || '{}');
            const organization = JSON.parse(localStorage.getItem('organization') || '{}');
            
            if (currentEmployee.first_name) {
                document.getElementById('userInfo').textContent = 
                    `${currentEmployee.first_name} ${currentEmployee.last_name} (${currentEmployee.role}) - ${organization.name || 'Organization'}`;
            }

            // Check if user has permission to access this page
            if (!['admin', 'super_admin'].includes(currentEmployee.role)) {
                showAlert('You do not have permission to access this page', 'danger');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
                return false;
            }

            return true;
        }

        function setupEventListeners() {
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Color preview
            document.getElementById('primaryColor').addEventListener('change', function() {
                document.getElementById('colorPreview').style.backgroundColor = this.value;
            });

            // Password policy updates
            const passwordFields = ['passwordMinLength', 'requireUppercase', 'requireNumbers', 'requireSpecialChars'];
            passwordFields.forEach(field => {
                document.getElementById(field).addEventListener('change', updatePasswordPolicy);
            });
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            alertContainer.innerHTML = alertHtml;
        }

        async function loadSettings() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/rbac/settings', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    populateSettings(data.grouped_settings || {});
                    originalSettings = data.grouped_settings || {};
                } else {
                    // Load default values
                    loadDefaultSettings();
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                loadDefaultSettings();
            }
        }

        function loadDefaultSettings() {
            // Set default values
            const defaults = {
                organizationName: 'My Organization',
                primaryColor: '#667eea',
                timezone: 'UTC',
                dateFormat: 'YYYY-MM-DD',
                currency: 'USD',
                standardWorkHours: 8,
                gracePeriod: 15,
                requireGPS: false,
                autoCheckout: true,
                annualLeaveDays: 20,
                sickLeaveDays: 10,
                personalLeaveDays: 5,
                requireApproval: true,
                advanceNotice: 7,
                enableTwoFactor: false,
                sessionTimeout: 480,
                emailNotifications: true,
                smsNotifications: false,
                notificationEmail: currentEmployee.email || ''
            };

            Object.keys(defaults).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = defaults[key];
                    } else {
                        element.value = defaults[key];
                    }
                }
            });

            // Update color preview
            document.getElementById('colorPreview').style.backgroundColor = defaults.primaryColor;
        }

        function populateSettings(groupedSettings) {
            // Populate form fields with loaded settings
            Object.keys(groupedSettings).forEach(category => {
                groupedSettings[category].forEach(setting => {
                    const element = document.querySelector(`[data-key="${setting.key}"]`);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = setting.value;
                        } else {
                            element.value = setting.value;
                        }
                    }
                });
            });

            // Update color preview
            const primaryColor = document.getElementById('primaryColor').value;
            if (primaryColor) {
                document.getElementById('colorPreview').style.backgroundColor = primaryColor;
            }

            // Load password policy if exists
            const passwordPolicy = groupedSettings.security?.find(s => s.key === 'password_policy');
            if (passwordPolicy && passwordPolicy.value) {
                try {
                    const policy = typeof passwordPolicy.value === 'string' ? 
                                  JSON.parse(passwordPolicy.value) : passwordPolicy.value;
                    
                    if (policy.min_length) document.getElementById('passwordMinLength').value = policy.min_length;
                    if (policy.require_uppercase) document.getElementById('requireUppercase').checked = policy.require_uppercase;
                    if (policy.require_numbers) document.getElementById('requireNumbers').checked = policy.require_numbers;
                    if (policy.require_special_chars) document.getElementById('requireSpecialChars').checked = policy.require_special_chars;
                } catch (e) {
                    console.warn('Error parsing password policy:', e);
                }
            }
        }

        function updatePasswordPolicy() {
            // This function updates the password policy object when individual fields change
            const policy = {
                min_length: parseInt(document.getElementById('passwordMinLength').value) || 8,
                require_uppercase: document.getElementById('requireUppercase').checked,
                require_numbers: document.getElementById('requireNumbers').checked,
                require_special_chars: document.getElementById('requireSpecialChars').checked
            };

            // Store the policy object (will be saved when saveAllSettings is called)
            window.passwordPolicy = policy;
        }

        async function saveAllSettings() {
            try {
                const settingsToSave = [];

                // Collect all form elements with data-key attributes
                const settingElements = document.querySelectorAll('[data-key]');
                
                settingElements.forEach(element => {
                    const key = element.getAttribute('data-key');
                    const category = element.getAttribute('data-category') || 'general';
                    const isSensitive = element.getAttribute('data-sensitive') === 'true';
                    
                    let value;
                    let dataType = 'string';
                    
                    if (element.type === 'checkbox') {
                        value = element.checked;
                        dataType = 'boolean';
                    } else if (element.type === 'number') {
                        value = parseFloat(element.value) || 0;
                        dataType = 'integer';
                    } else {
                        value = element.value;
                    }

                    settingsToSave.push({
                        key: key,
                        value: value,
                        category: category,
                        data_type: dataType,
                        is_sensitive: isSensitive,
                        description: getSettingDescription(key)
                    });
                });

                // Add password policy as a JSON setting
                if (window.passwordPolicy) {
                    settingsToSave.push({
                        key: 'password_policy',
                        value: window.passwordPolicy,
                        category: 'security',
                        data_type: 'json',
                        is_sensitive: false,
                        description: 'Password complexity requirements'
                    });
                }

                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/rbac/settings', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settingsToSave)
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert(`Settings saved successfully! Updated ${result.updated_settings.length} settings.`, 'success');
                    
                    // Reload settings to reflect any server-side changes
                    setTimeout(loadSettings, 1000);
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save settings');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showAlert('Error saving settings: ' + error.message, 'danger');
            }
        }

        function getSettingDescription(key) {
            const descriptions = {
                'organization_name': 'The official name of the organization',
                'primary_color': 'Main brand color used throughout the application',
                'timezone': 'Default timezone for the organization',
                'date_format': 'How dates are displayed in the application',
                'currency': 'Default currency for financial calculations',
                'standard_work_hours': 'Number of hours considered a full work day',
                'grace_period_minutes': 'Late arrival tolerance in minutes',
                'require_gps_checkin': 'Whether GPS verification is required for check-in',
                'auto_checkout': 'Automatically check out employees after work hours',
                'annual_leave_days': 'Default annual leave allocation per employee',
                'sick_leave_days': 'Default sick leave allocation per employee',
                'personal_leave_days': 'Default personal leave allocation per employee',
                'require_manager_approval': 'Whether leave requests need manager approval',
                'advance_notice_days': 'Minimum days in advance for leave requests',
                'enable_two_factor': 'Require two-factor authentication for all users',
                'session_timeout_minutes': 'Auto logout after inactivity (minutes)',
                'email_notifications': 'Send email notifications for events',
                'sms_notifications': 'Send SMS notifications for urgent events',
                'notification_email': 'Email address for system notifications'
            };
            return descriptions[key] || '';
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('employee');
            localStorage.removeItem('organization');
            
            showAlert('Logged out successfully', 'success');
            setTimeout(() => {
                window.location.href = '/login';
            }, 1000);
        }
    </script>
</body>
</html>